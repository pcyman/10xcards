---
import Layout from "@/layouts/Layout.astro";
import { DeckDetailView } from "@/components/deck-detail/DeckDetailView";
import type { DeckDTO, FlashcardDTO, PaginatedResponseDTO } from "@/types";

// Disable prerendering for this dynamic page
export const prerender = false;

const { id } = Astro.params;

// Validate deck ID format (should be UUID)
const UUID_REGEX =
  /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

if (!id || !UUID_REGEX.test(id)) {
  return Astro.redirect("/404");
}

// Try to fetch initial data server-side if auth token is available
let initialDeck: DeckDTO | null = null;
let initialFlashcards: PaginatedResponseDTO<FlashcardDTO> | null = null;

const authHeader = Astro.request.headers.get("Authorization");
const token = authHeader?.startsWith("Bearer ")
  ? authHeader.substring(7)
  : null;

if (token) {
  try {
    // Fetch deck details
    const deckResponse = await fetch(`${Astro.url.origin}/api/decks/${id}`, {
      headers: {
        Authorization: `Bearer ${token}`,
      },
    });

    if (deckResponse.ok) {
      initialDeck = await deckResponse.json();

      // Fetch initial flashcards (page 1, limit 50, sorted by created_at desc)
      const flashcardsResponse = await fetch(
        `${Astro.url.origin}/api/decks/${id}/flashcards?page=1&limit=50&sort=created_at&order=desc`,
        {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        },
      );

      if (flashcardsResponse.ok) {
        initialFlashcards = await flashcardsResponse.json();
      }
    } else if (deckResponse.status === 404) {
      // Deck not found
      return Astro.redirect("/404");
    }
  } catch (error) {
    console.error("Error fetching initial data:", error);
    // Continue to render client-side component, it will handle auth
  }
}

const pageTitle = initialDeck ? initialDeck.name : "Deck Details";
---

<Layout title={pageTitle}>
  <main role="main">
    <DeckDetailView
      client:only="react"
      initialDeck={initialDeck}
      initialFlashcards={initialFlashcards}
      deckId={id}
    />
  </main>
</Layout>
